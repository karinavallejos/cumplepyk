<!DOCTYPE html>
<html>
<head>
    <title>Chicharra Virtual</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { text-align: center; font-family: sans-serif; padding: 2em; }
        button { padding: 1em 2em; font-size: 1.5em; }
        input, select { font-size: 1.2em; padding: 0.5em; margin: 0.5em; }
        .ranking { margin-top: 2em; }
    </style>
</head>
<body>
    <h1>🔔 Chicharra Virtual</h1>

    <div id="registro">
        <p><strong>Selecciona tu nombre y mesa</strong></p>
        <input id="nombre" placeholder="Tu nombre">
        <select id="mesa">
            <option disabled selected>Mesa</option>
            <option>Mesa 1</option>
            <option>Mesa 2</option>
            <option>Mesa 3</option>
            <option>Mesa 4</option>
            <option>Mesa 5</option>
        </select><br>
        <button onclick="guardarDatos()">Entrar</button>
    </div>

    <div id="buzzer" style="display:none;">
        <p id="usuarioActivo"></p>
        <form id="formBuzz" action="/buzz" method="post">
            <input type="hidden" id="nombre_hidden" name="nombre">
            <button type="submit">🔔 ¡BUZZ!</button>
        </form>
    </div>

    <div class="ranking">
        <h2>Orden de pulsación</h2>
        <ul id="lista"></ul>
    </div>

    <script>
        function guardarDatos() {
            const nombre = document.getElementById("nombre").value.trim();
            const mesa = document.getElementById("mesa").value;
            if (!nombre || mesa === "Mesa") {
                alert("Completa tu nombre y selecciona una mesa.");
                return;
            }
            const usuario = `${nombre} (${mesa})`;
            localStorage.setItem("usuario", usuario);
            mostrarBuzzer();
        }

        function mostrarBuzzer() {
            const usuario = localStorage.getItem("usuario");
            if (usuario) {
                document.getElementById("registro").style.display = "none";
                document.getElementById("buzzer").style.display = "block";
                document.getElementById("nombre_hidden").value = usuario;
                document.getElementById("usuarioActivo").textContent = `Jugador: ${usuario}`;
            }
        }

        async function actualizar() {
            const res = await fetch("/estado");
            const datos = await res.json();
            const lista = document.getElementById("lista");
            lista.innerHTML = "";
            datos.forEach((item, index) => {
                const li = document.createElement("li");
                li.textContent = `${index + 1}. ${item.nombre} - ${item.hora}`;
                lista.appendChild(li);
            });
        }

        mostrarBuzzer();
        setInterval(actualizar, 1000);
    </script>

    <br><br>
    <form action="/reset" method="post">
        <input type="password" name="clave" placeholder="Clave del host para reiniciar">
        <button type="submit">🔁 Reiniciar (solo host)</button>
    </form>

</body>
</html>
